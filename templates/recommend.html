{% extends "base.html" %}

{% block title %}Crop Recommendation - Precision Agriculture{% endblock %}

{% block content %}
<div class="container">
  <div class="form-container animate-fade-in">
    <h1 style="text-align: center; margin-bottom: 2rem;">Crop Recommendation</h1>
    <form id="rec-form" action="{{ url_for('crop_recommendation_app.recommend') }}" method="post">
      <div class="form-group">
        <label for="nitrogen">Nitrogen <small style="color:#6b7280;">(typ. 0-140)</small></label>
        <input type="number" id="nitrogen" name="nitrogen" step="0.1" required
          placeholder="Enter Nitrogen content (0-140)">
      </div>

      <div class="form-group">
        <label for="phosphorus">Phosphorus <small style="color:#6b7280;">(typ. 5-145)</small></label>
        <input type="number" id="phosphorus" name="phosphorus" step="0.1" required
          placeholder="Enter Phosphorus content (5-145)">
      </div>

      <div class="form-group">
        <label for="potassium">Potassium <small style="color:#6b7280;">(typ. 5-205)</small></label>
        <input type="number" id="potassium" name="potassium" step="0.1" required
          placeholder="Enter Potassium content (5-205)">
      </div>

      <div class="form-group">
        <label for="temperature">Temperature (°C) <small style="color:#6b7280;">(typ. 5-50)</small></label>
        <input type="number" id="temperature" name="temperature" step="0.1" required
          placeholder="Enter Temperature (5-50)">
      </div>

      <div class="form-group">
        <label for="humidity">Humidity (%) <small style="color:#6b7280;">(typ. 10-100)</small></label>
        <input type="number" id="humidity" name="humidity" step="0.1" required placeholder="Enter Humidity (10-100)">
      </div>

      <div class="form-group">
        <label for="ph_value">pH Value (0-14) <small style="color:#6b7280;">(typ. 3-10)</small></label>
        <input type="number" id="ph_value" name="ph_value" step="0.1" required placeholder="Enter pH value (3-10)">
      </div>

      <div class="form-group">
        <label for="rainfall">Rainfall (mm) <small style="color:#6b7280;">(typ. 0-400)</small></label>
        <input type="number" id="rainfall" name="rainfall" step="0.1" required placeholder="Enter Rainfall (0-400)">
      </div>

      <div style="text-align: center; margin-top: 2rem; display:flex; gap:8px;">
        <button type="submit" class="btn" style="flex:1;">Recommend Crop</button>
        <button type="button" id="geo-btn" class="btn btn-geo" style="flex:1;">Use My Location</button>
        <button type="button" id="live-geo-btn" class="btn btn-live" style="flex:1;">Live Location</button>
      </div>
    </form>
    <!-- suggestions box removed -->
    {% if error %}
    <div
      style="margin-top: 1.5rem; padding: 1rem; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 8px; color: #fca5a5; text-align: center;">
      {{ error }}
    </div>
    {% endif %}
  </div>
</div>

<script id="domain-limits" type="application/json">{{ domain_limits | tojson | safe }}</script>
<script>
  const domainLimits = JSON.parse(document.getElementById('domain-limits').textContent || '{}');
  const form = document.getElementById('rec-form');
  const geoBtn = document.getElementById('geo-btn');
  const liveBtn = document.getElementById('live-geo-btn');

  form.addEventListener('submit', function (e) {
    const bad = [];
    for (const k in domainLimits) {
      // normalize domain key to input `name` convention: replace non-alphanum with '_', lower-case
      const name = k.replace(/[^A-Za-z0-9_]/g, '_').toLowerCase();
      const el = document.getElementsByName(name)[0];
      if (!el) continue;
      const v = parseFloat(el.value);
      const [low, high] = domainLimits[k];
      if (isNaN(v) || v < low || v > high) {
        bad.push(`${k}=${v} (expected ${low}–${high})`);
      }
    }
    if (bad.length) {
      e.preventDefault();
      const msg = 'Client validation failed: ' + bad.join('; ');
      alert(msg);
      return false;
    }
  });

  function handleLocationRedirect(lat, lon) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('crop_recommendation_app.recommend_location') }}";

    const latField = document.createElement('input');
    latField.type = 'hidden';
    latField.name = 'lat';
    latField.value = lat;
    form.appendChild(latField);

    const lonField = document.createElement('input');
    lonField.type = 'hidden';
    lonField.name = 'lon';
    lonField.value = lon;
    form.appendChild(lonField);

    document.body.appendChild(form);
    form.submit();
  }

  function getLocationAndRedirect() {
    if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(function (pos) {
      handleLocationRedirect(pos.coords.latitude, pos.coords.longitude);
    }, function (err) {
      alert('Geolocation denied or failed: ' + err.message);
    });
  }

  geoBtn.addEventListener('click', getLocationAndRedirect);
  liveBtn.addEventListener('click', getLocationAndRedirect);
</script>

{% endblock %}