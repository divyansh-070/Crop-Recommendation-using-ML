{% extends "base.html" %}

{% block title %}Crop Recommendation - Precision Agriculture{% endblock %}

{% block content %}
<div class="container">
  <div class="form-container animate-fade-in">
    <h1 style="text-align: center; margin-bottom: 2rem;">Crop Recommendation</h1>
    <form id="rec-form" action="{{ url_for('crop_recommendation_app.recommend') }}" method="post">
      <div class="form-group">
        <label for="nitrogen">Nitrogen <small style="color:#6b7280;">(typ. 0-140)</small></label>
        <input type="number" id="nitrogen" name="nitrogen" step="0.1" required placeholder="Enter Nitrogen content (0-140)">
      </div>

      <div class="form-group">
        <label for="phosphorus">Phosphorus <small style="color:#6b7280;">(typ. 5-145)</small></label>
        <input type="number" id="phosphorus" name="phosphorus" step="0.1" required
          placeholder="Enter Phosphorus content (5-145)">
      </div>

      <div class="form-group">
        <label for="potassium">Potassium <small style="color:#6b7280;">(typ. 5-205)</small></label>
        <input type="number" id="potassium" name="potassium" step="0.1" required placeholder="Enter Potassium content (5-205)">
      </div>

      <div class="form-group">
        <label for="temperature">Temperature (°C) <small style="color:#6b7280;">(typ. 5-50)</small></label>
        <input type="number" id="temperature" name="temperature" step="0.1" required placeholder="Enter Temperature (5-50)">
      </div>

      <div class="form-group">
        <label for="humidity">Humidity (%) <small style="color:#6b7280;">(typ. 10-100)</small></label>
        <input type="number" id="humidity" name="humidity" step="0.1" required placeholder="Enter Humidity (10-100)">
      </div>

      <div class="form-group">
        <label for="ph_value">pH Value (0-14) <small style="color:#6b7280;">(typ. 3-10)</small></label>
        <input type="number" id="ph_value" name="ph_value" step="0.1" required placeholder="Enter pH value (3-10)">
      </div>

      <div class="form-group">
        <label for="rainfall">Rainfall (mm) <small style="color:#6b7280;">(typ. 0-400)</small></label>
        <input type="number" id="rainfall" name="rainfall" step="0.1" required placeholder="Enter Rainfall (0-400)">
      </div>

      <div style="text-align: center; margin-top: 2rem; display:flex; gap:8px;">
        <button type="submit" class="btn" style="flex:1;">Recommend Crop</button>
        <button type="button" id="geo-btn" class="btn btn-geo" style="flex:1;">Use My Location</button>
        <button type="button" id="live-geo-btn" class="btn btn-live" style="flex:1;">Live Location</button>
      </div>
    </form>
    <div id="suggestions-box" style="margin-top:1rem; padding:0.75rem; background:#f3f4f6; border-radius:6px; color:#111827; text-align:center;">Suggestions will appear here when using location features.</div>
    {% if error %}
    <div
      style="margin-top: 1.5rem; padding: 1rem; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 8px; color: #fca5a5; text-align: center;">
      {{ error }}
    </div>
    {% endif %}
  </div>
</div>

<script id="domain-limits" type="application/json">{{ domain_limits | tojson | safe }}</script>
<script>
const domainLimits = JSON.parse(document.getElementById('domain-limits').textContent || '{}');
const form = document.getElementById('rec-form');
const geoBtn = document.getElementById('geo-btn');

form.addEventListener('submit', function(e){
  const bad = [];
  for (const k in domainLimits){
    // normalize domain key to input `name` convention: replace non-alphanum with '_', lower-case
    const name = k.replace(/[^A-Za-z0-9_]/g, '_').toLowerCase();
    const el = document.getElementsByName(name)[0];
    if (!el) continue;
    const v = parseFloat(el.value);
    const [low, high] = domainLimits[k];
    if (isNaN(v) || v < low || v > high){
      bad.push(`${k}=${v} (expected ${low}–${high})`);
    }
  }
  if (bad.length){
    e.preventDefault();
    const msg = 'Client validation failed: ' + bad.join('; ');
    alert(msg);
    return false;
  }
});

geoBtn.addEventListener('click', function(){
  if (!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(async function(pos){
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    try{
      const res = await fetch('{{ url_for("crop_recommendation_app.location_suggest") }}', {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({lat,lon})
      });
      const data = await res.json();
      const box = document.getElementById('suggestions-box');
      if (data.crops && data.crops.length){
        const txt = 'Suggested crops for ' + (data.state||'your area') + ': ' + data.crops.join(', ') + (data.cached ? ' (cached)' : '');
        alert(txt);
        box.innerText = txt;
        if (data.cached){ box.classList.add('updated'); setTimeout(()=>box.classList.remove('updated'), 2200); } else { box.classList.remove('updated'); }
      } else if (data.error){
        alert('Location suggestion failed: ' + data.error);
        box.innerText = 'Location suggestion failed: ' + data.error;
        box.classList.remove('updated');
      } else {
        box.innerText = 'No suggestions for your area';
        box.classList.remove('updated');
      }
    } catch(err){ alert('Location request failed: '+err); }
  }, function(err){ alert('Geolocation denied or failed: '+err.message); });
});

// Live location watch
let watchId = null;
const liveBtn = document.getElementById('live-geo-btn');
liveBtn.addEventListener('click', function(){
  if (watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    liveBtn.innerText = 'Live Location';
    document.getElementById('suggestions-box').innerText = 'Live tracking stopped';
    return;
  }
  if (!navigator.geolocation){ alert('Geolocation not supported'); return; }
  watchId = navigator.geolocation.watchPosition(async function(pos){
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
      try{
        const res = await fetch('{{ url_for("crop_recommendation_app.location_suggest") }}', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({lat,lon})
        });
        const data = await res.json();
        const box = document.getElementById('suggestions-box');
        if (data.crops && data.crops.length){
          const txt = 'Suggested crops for ' + (data.state||'your area') + ': ' + data.crops.join(', ') + (data.cached ? ' (cached)' : '');
          box.innerText = txt;
          if (data.cached){ box.classList.add('updated'); setTimeout(()=>box.classList.remove('updated'), 2200); } else { box.classList.remove('updated'); }
        } else if (data.error){
          box.innerText = 'Location suggestion failed: ' + data.error;
          box.classList.remove('updated');
        } else {
          box.innerText = 'No suggestions for your area';
          box.classList.remove('updated');
        }
        liveBtn.innerText = 'Stop Live';
      } catch(err){ const box = document.getElementById('suggestions-box'); box.innerText = 'Location request failed: '+err; box.classList.remove('updated'); }
  }, function(err){ document.getElementById('suggestions-box').innerText = 'Geolocation denied or failed: '+err.message; }, {maximumAge:5000, timeout:10000, enableHighAccuracy:false});
});
</script>

{% endblock %}
